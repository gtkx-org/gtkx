# CLAUDE.md - Global Project Guidelines

## Project Architecture

### Package Overview

This is a monorepo containing the following key packages in `packages/`:

| Package   | Purpose                             |
| --------- | ----------------------------------- |
| `native`  | Rust native module (NAPI via Neon)  |
| `ffi`     | TypeScript FFI bindings to GTK/GLib |
| `react`   | React reconciler for GTK widgets    |
| `css`     | CSS-in-JS styling for GTK           |
| `codegen` | Code generation from GIR files      |
| `gir`     | GIR parsing utilities               |
| `cli`     | CLI tooling                         |
| `testing` | Test utilities                      |
| `e2e`     | End-to-end tests (reconciler nodes) |

### Native Module (`packages/native`)

The Rust native module **only** contains cross-thread communication and marshaling logic:

- **JS ↔ GLib thread communication** (dispatch between JavaScript and GTK main loop)
- **Value marshaling** (converting between JS and GLib types)
- **Trampolines** (callback wrappers for signal handling)

**IMPORTANT:** The native module does NOT contain any GTK/GLib-specific bindings. It is purely a translation layer for FFI calls. The native module has been thoroughly tested with hundreds of FFI calls, so it should **NOT** be the first place to investigate when debugging issues.

### FFI Package (`packages/ffi`)

Contains all FFI bindings to GTK/GLib libraries:

- **Autogenerated** from GIR files located in `/girs`
- Generated files are in `src/generated/` and are **gitignored**
- To find generated code, use `grep` or `find` in the terminal (Glob won't see them)
- **IMPORTANT:** The FFI package is 100% generated from GIR files with zero manual code. Every method, property, and signal defined in the GIR files is available. Do not waste time asking whether a specific GTK/GLib/Adw API is "supported" — it is.

### React Package (`packages/react`)

The React reconciler for GTK:

- **Does NOT contain FFI bindings** (those are in `packages/ffi`)
- **Does NOT contain React components** (no `<MyComponent>` wrappers)
- **Does NOT contain tests** (they are in `packages/e2e`)
- All GTK/Adw elements are implemented as **specialized reconciler nodes** in `src/nodes/`
- JSX intrinsic elements (`<GtkButton>`, `<AdwWindow>`, etc.) are **autogenerated** in `src/generated/`

### CSS Package (`packages/css`)

**ALL** CSS styling must use `@gtkx/css`. Do not use inline styles or other CSS approaches.

## Code Generation

GIR files in `/girs` are processed by `packages/codegen` to generate:

1. FFI bindings in `packages/ffi/src/generated/`
2. JSX intrinsic types in `packages/react/src/generated/`

Run codegen with: `turbo codegen`

## Testing

**CRITICAL:** NEVER run `npx tsc` directly — it does not work with project references. Always use `turbo` to run typecheck and other build commands.

**IMPORTANT:** Do NOT run `turbo test` at the root level - it will run recursively and cause issues. Instead:

- Run all tests: `pnpm test` (at root level)
- Run specific package tests: `turbo test --filter=<package-name>`
- Run lint: `pnpm lint` (at root level)
- Run specific package lint: `turbo lint --filter<package-name>`
- Run typecheck: `pnpm typecheck` (at root level)
- Run specific package typecheck: `turbo typecheck --filter=<package-name>`
- Run knip: `pnpm knip` (at root level)
- **Autofix linter issues:** If linter issues are autofixable, use `pnpm biome check --write` instead of fixing them manually

**CRITICAL:** Any GTK/GLib warning or error in test output (e.g., `Gtk-CRITICAL`, `GLib-GObject-WARNING`, `Adwaita-CRITICAL`) must be treated as a critical issue and fixed immediately, even if tests pass.

**IMPORTANT:** The testing environment is **NOT headless**. It is a fully functional GTKX application identical to a real one in every way. The only difference is that it runs under Xvfb (a virtual framebuffer) instead of a physical monitor. All GTK APIs, signals, event controllers, widget activation, animations, and rendering behave exactly as they would in a real application.

## Debugging Guidelines

When investigating errors, **ALWAYS** trace exactly where and why the error occurs. Do not search blindly through the codebase.

### Common Issue Sources (in order of likelihood)

1. **Codegen issues** - Problems in generated bindings (check generation logic in `packages/codegen`)
2. **Reconciler issues** - Problems in React node implementations (`packages/react/src/nodes/`)
3. **Native module** - Only investigate last; this layer is well-tested

### Debugging Strategy

1. Identify the exact error message and stack trace
2. Determine if it's a codegen, reconciler, or FFI issue
3. Trace the call path from the React node through FFI to native
4. Check if the GIR definition matches the expected API
